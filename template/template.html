<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S-UI Dashboard</title>

    <script src="static/chart.js"></script>
    <script src="static/chartjs-adapter-date-fns.js"></script>

    <style>
        /* 全局样式 */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background:#f0f2f5;
            margin:0;
            padding:20px;
            color:#333;
        }
        h2 {
            margin-bottom: 15px;
            font-size: 1.6em;
            color: #1890ff;
            margin-top: -8px;
        }

        /* 卡片网格 */
        .grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap:20px;
            margin-bottom:20px;
        }

        /* 卡片样式 */
        .card {
            background: linear-gradient(145deg,#ffffff,#f9f9f9);
            border-radius:12px;
            padding:20px;
            box-shadow:0 6px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow:0 10px 25px rgba(0,0,0,0.12);
        }
        .card p, .card strong {
            margin:6px 0;
            font-size:1.05em;
        }
        .card strong {
            color:#1890ff;
        }

        /* 合并信息显示 */
        .card .info-group {
            display:flex;
            flex-direction: column;
            gap:6px;
        }

        /* 下拉选择和按钮 */
        .select-group {
            display:flex;
            align-items:center;
            flex-wrap:wrap;
            margin-bottom:15px;
        }
        select, button {
            padding:6px 14px;
            border-radius:6px;
            border:1px solid #ccc;
            margin-right:10px;
            font-size:0.95em;
        }
        button {
            background:#1890ff;
            color:#fff;
            border:none;
            cursor:pointer;
            transition:background 0.2s;
        }
        button:hover {
            background:#40a9ff;
        }

        /* 图表容器 */
        .chart-container {
            position:relative;
            width:100%;
            height:400px;
        }
        .loading-overlay {
            position:absolute;
            top:0; left:0;
            width:100%; height:100%;
            background: rgba(255,255,255,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index:10;
            font-size:1.2em;
            color:#1890ff;
            display:none;
        }

        /* 紧凑型信息布局 */
        .kv {
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-size:0.95em;
        }

        .kv span.value {
            font-weight:600;
            color:#333;
        }

        .kv span.value.primary {
            font-size:1.15em;
            color:#1890ff;
        }

        .card.compact {
            padding:16px;
        }

        .card.compact p {
            margin:4px 0;
        }

        /* 流量统计单卡片 */
        .traffic-card {
            padding:16px 18px;
        }

        .traffic-grid {
            display:grid;
            grid-template-columns: repeat(2, 1fr);
            gap:14px 20px;
        }

        .traffic-item {
            display:flex;
            flex-direction:column;
            gap:4px;
        }

        .traffic-item .label {
            font-size: 1.05em;
            font-weight: bold;
            color: #1890ff;
        }

        .traffic-item .value {
            font-size:1.25em;
            font-weight:600;
            color:#666;
            line-height:1.2;
        }

        /* 移动端自动单列 */
        @media(max-width:480px){
            .traffic-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 响应式调整 */
        @media(max-width:768px){
            .grid { grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
        }
        @media(max-width:480px){
            body { padding:10px; }
            h2 { font-size:1.3em; }
            .select-group { flex-direction:column; align-items:flex-start; }
            select, button { margin-bottom:8px; }
        }
    </style>
</head>
<body>

<h2>System Overview</h2>
<div class="grid">

    <div class="card compact">
        <div class="kv">
            <strong>Status</strong>
            <span class="value" id="status">Running</span>
        </div>
        <div class="kv">
            <strong>Runtime</strong>
            <span class="value">{{.Runtime}}</span>
        </div>
        <div class="kv">
            <strong>User</strong>
            <span class="value">{{.User}}</span>
        </div>
        <div class="kv">
            <strong>Expiry</strong>
            <span class="value">{{.Expiry}}</span>
        </div>
    </div>

    <div class="card compact traffic-card">
        <div class="traffic-grid">
            <!-- 已使用流量 -->
            <div class="traffic-item">
                <span class="label">Used</span>
                <span class="value" id="usedTraffic">0 GB</span>
            </div>

            <!-- 上传 / 下载合并显示 -->
            <div class="traffic-item">
                <span class="label">Traffic</span>
                <span class="value" id="totalTraffic">↑ {{printf "%.2f GB" .UpGB}} / ↓ {{printf "%.2f GB" .DownGB}}</span>
            </div>

            <!-- 剩余流量 -->
            <div class="traffic-item">
                <span class="label">Remaining</span>
                <span class="value" id="remaining">{{.Remaining}}</span>
            </div>

            <!-- 总流量 -->
            <div class="traffic-item">
                <span class="label">Total</span>
                <span class="value" id="totalStr">{{.TotalStr}} Monthly</span>
            </div>
        </div>
    </div>
</div>

<h2>Traffic Details</h2>
<div class="card" style="position:relative;">
    <div class="select-group">
        <label>Time Range:
            <select id="limit">
                <option value="1">1 hour</option>
                <option value="6" selected>6 hours</option>
                <option value="12">12 hours</option>
                <option value="1d">1 day</option>
                <option value="7d">7 days</option>
                <option value="15d">15 days</option>
                <option value="30d">30 days</option>
            </select>
        </label>
        <button id="refreshBtn">Refresh</button>
    </div>
    <div class="chart-container">
        <canvas id="trafficChart"></canvas>
        <div id="loading" class="loading-overlay">Loading...</div>
    </div>
</div>

<script>
    // ---------- Traffic Chart ----------
    let chart;
    function getUserFromURL(){
        const params=new URLSearchParams(window.location.search);
        return params.get('user')||'';
    }
    function downsampleData(data,maxPoints=500){
        if(data.length<=maxPoints) return data;
        const step=Math.ceil(data.length/maxPoints);
        return data.filter((_,idx)=>idx%step===0);
    }
    function getTimeUnit(limit){
        switch(limit){
            case '1': case '6': case '12': return 'hour';
            default: return 'day';
        }
    }

    async function loadTraffic() {
        const user = getUserFromURL();
        const limit = document.getElementById('limit').value;
        const loadingEl = document.getElementById('loading');
        loadingEl.style.display = 'flex';

        try {
            const res = await fetch(`/api/traffic?user=${user}&limit=${limit}`);
            const data = await res.json();

            let upTotal = 0;
            let downTotal = 0;

            data.forEach(p => {
                upTotal += p.up;
                downTotal += p.down;
            });

            // 计算已使用流量
            const upGB = parseFloat('{{.UpGB}}') || 0;
            const downGB = parseFloat('{{.DownGB}}') || 0;
            const usedGB = (upGB + downGB).toFixed(2);
            document.getElementById('usedTraffic').textContent = usedGB + ' GB';

            // 更新图表
            let upData = data.map(p => ({x: p.time*1000, y: p.up}));
            let downData = data.map(p => ({x: p.time*1000, y: p.down}));
            upData = downsampleData(upData);
            downData = downsampleData(downData);

            if(!chart){
                chart = new Chart(document.getElementById('trafficChart'), {
                    type:'line',
                    data:{datasets:[
                            {label:'Upload (MB)', data: upData, borderColor:'#ff4d4f', fill:false, tension:0.2, pointRadius:1},
                            {label:'Download (MB)', data: downData, borderColor:'#1890ff', fill:false, tension:0.2, pointRadius:1}
                        ]},
                    options:{
                        responsive:true,
                        maintainAspectRatio:false,
                        animation:{duration:1000,easing:'easeOutQuart'},
                        plugins:{
                            legend:{position:'top',labels:{font:{size:12}}},
                            tooltip:{
                                mode:'index', intersect:false,
                                callbacks:{
                                    title:ctx=>{
                                        const date=new Date(ctx[0].parsed.x);
                                        return date.toLocaleString('en-US',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
                                    },
                                    label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y} MB`
                                }
                            }
                        },
                        interaction:{mode:'index',intersect:false},
                        parsing:false,
                        normalized:true,
                        scales:{
                            x:{type:'time', time:{tooltipFormat:'yyyy-MM-dd HH:mm', unit:getTimeUnit(limit)}, title:{display:true,text:'Time'}},
                            y:{beginAtZero:true, title:{display:true,text:'MB'}}
                        }
                    }
                });
            } else {
                chart.data.datasets[0].data = upData;
                chart.data.datasets[1].data = downData;
                chart.options.scales.x.time.unit = getTimeUnit(limit);
                chart.update('none');
            }

        } catch(err){
            console.error(err);
            alert("Failed to load traffic data!");
        } finally {
            loadingEl.style.display = 'none';
        }
    }

    loadTraffic();
    document.getElementById('refreshBtn').addEventListener('click',loadTraffic);
    document.getElementById('limit').addEventListener('change',loadTraffic);
</script>

</body>
</html>
